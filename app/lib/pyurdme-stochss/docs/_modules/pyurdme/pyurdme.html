<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyurdme.pyurdme &mdash; PyURDME 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="PyURDME 1.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">PyURDME 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyurdme.pyurdme</h1><div class="highlight"><pre>
<span class="c"># pylint: disable-msg=C0301</span>
<span class="c"># pylint: disable-msg=C0103</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># This is only needed if we are running in an Ipython Notebook</span>
    <span class="kn">import</span> <span class="nn">IPython.display</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;PyURDME requires h5py.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dolfin</span>
    <span class="n">dolfin</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s">&quot;linear_algebra_backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;uBLAS&quot;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;PyURDME requires FeniCS/Dolfin.&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c"># Set log level to report only errors or worse</span>
<span class="n">dolfin</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<div class="viewcode-block" id="URDMEModel"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel">[docs]</a><span class="k">class</span> <span class="nc">URDMEModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An URDME Model extends Model with spatial information and methods to create URDME solver input.</span>
<span class="sd">        TODO: Documentiation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c"># Currently not used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd_initialied</span><span class="o">=</span><span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stiffness_matrices</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrices</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c"># subdomins is a list of MeshFunctions with subdomain marker information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c"># This dictionary hold information about the subdomains each species is active on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># URDMEDataFunction objects to construct the data vector.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listOfDataFunctions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Volume of each voxel in the dolfin dof ordering (not vetex ordering).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dofvol</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by pickle to get state when pickling. Because we</span>
<span class="sd">            have Swig wrappers to extension modules, we need to remove some instance variables</span>
<span class="sd">            for the object to pickle. &quot;&quot;&quot;</span>

        <span class="c">#  Filter out any instance variable that is not picklable...</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;mesh&quot;</span><span class="p">:</span>
                    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.xml&quot;</span><span class="p">)</span>
                    <span class="n">dolfin</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">item</span>
                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">constrained_domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c"># Warning: This is black magic.</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cdd</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">cdd</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">constrained_domain</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
                            <span class="n">cdd</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">constrained_domain</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
                            <span class="n">cdd</span><span class="p">[</span><span class="s">&#39;dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">constrained_domain</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;SwigPyObject&#39;</span><span class="p">:</span>
                                    <span class="n">cdd</span><span class="p">[</span><span class="s">&#39;dict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;constrained_domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdd</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;error pickling mesh.constrained_domain: {0}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">num_dof_voxels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;num_dof_voxels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">num_dof_voxels</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&quot;subdomains&quot;</span><span class="p">:</span>
                    <span class="n">sddict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">sdkey</span><span class="p">,</span> <span class="n">sd_func</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.xml&quot;</span><span class="p">)</span>
                        <span class="n">dolfin</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">sd_func</span>
                        <span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">sddict</span><span class="p">[</span><span class="n">sdkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sddict</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>


        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by pickle to set state when unpickling. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">state</span>

        <span class="k">if</span> <span class="s">&#39;mesh&#39;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="c"># Recreate the mesh</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.xml&quot;</span><span class="p">)</span>
                <span class="n">fdname</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">name</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;data&#39;</span><span class="p">])</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mesh</span> <span class="o">=</span> <span class="n">URDMEMesh</span><span class="o">.</span><span class="n">read_dolfin_mesh</span><span class="p">(</span><span class="n">fdname</span><span class="p">)</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&#39;constrained_domain&#39;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]:</span>
                    <span class="c"># Black magic to match that in __getstate__</span>
                    <span class="n">cdd</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;constrained_domain&#39;</span><span class="p">]</span>
                    <span class="n">compiled_class</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cdd</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">],</span> <span class="s">&#39;pyurdme.mesh.constrained_domain&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
                    <span class="nb">eval</span><span class="p">(</span><span class="n">compiled_class</span><span class="p">)</span>
                    <span class="n">compiled_object</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;{0}()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdd</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cdd</span><span class="p">[</span><span class="s">&#39;dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">compiled_object</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">mesh</span><span class="o">.</span><span class="n">constrained_domain</span> <span class="o">=</span> <span class="n">compiled_object</span>
                <span class="k">if</span> <span class="s">&#39;num_dof_voxels&#39;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]:</span>
                    <span class="n">mesh</span><span class="o">.</span><span class="n">num_dof_voxels</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">][</span><span class="s">&#39;num_dof_voxels&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Error unpickling model, could not recreate the mesh.&quot;</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="s">&#39;subdomains&#39;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="c"># Recreate the subdomain functions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sddict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sdkey</span><span class="p">,</span> <span class="n">sd_func_str</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s">&quot;subdomains&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.xml&quot;</span><span class="p">)</span>
                    <span class="n">fdname</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sd_func_str</span><span class="p">)</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">fd_in</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fdname</span><span class="p">)</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">MeshFunction</span><span class="p">(</span><span class="s">&quot;size_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;mesh&quot;</span><span class="p">])</span>
                    <span class="n">fd_in</span> <span class="o">&gt;&gt;</span> <span class="n">func</span>
                    <span class="n">sddict</span><span class="p">[</span><span class="n">sdkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="s">&quot;subdomains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sddict</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Error unpickling model, could not recreate the subdomain functions&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

<div class="viewcode-block" id="URDMEModel.add_data_function"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.add_data_function">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a URDMEDataFunction object to this object. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_function</span><span class="p">,</span> <span class="n">URDMEDataFunction</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listOfDataFunctions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_function</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;data_function not of type URDMEDataFunction&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__initialize_species_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_map</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="URDMEModel.get_species_map"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.get_species_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_species_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the species map, name to index. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;species_map&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_species_map</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_map</span>
</div>
<div class="viewcode-block" id="URDMEModel.add_subdomain"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.add_subdomain">[docs]</a>    <span class="k">def</span> <span class="nf">add_subdomain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="p">[</span><span class="n">subdomain</span><span class="o">.</span><span class="n">dim</span><span class="p">()]</span> <span class="o">=</span> <span class="n">subdomain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelException</span><span class="p">(</span><span class="s">&quot;Failed to add subdomain function of dim &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;. Only one subdomain function of a given dimension is allowed.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="URDMEModel.create_stoichiometric_matrix"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.create_stoichiometric_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">create_stoichiometric_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate a stoichiometric matrix in sparse CSC format. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;species_map&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_species_map</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ND</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">):</span>
                <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">reactants</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactants</span>
                <span class="n">products</span>  <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">products</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reactants</span><span class="p">:</span>
                    <span class="n">ND</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">reactants</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
                    <span class="n">ND</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">products</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

            <span class="n">N</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">ND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">N</span>
</div>
<div class="viewcode-block" id="URDMEModel.create_dependency_graph"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.create_dependency_graph">[docs]</a>    <span class="k">def</span> <span class="nf">create_dependency_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct the sparse dependency graph. &quot;&quot;&quot;</span>
        <span class="c"># We cannot safely generate a dependency graph (without attempting to analyze the propensity string itself)</span>
        <span class="c"># if the model contains custom propensities.</span>
        <span class="n">mass_action_model</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfReactions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reaction</span><span class="o">.</span><span class="n">massaction</span><span class="p">:</span>
                <span class="n">GF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()))</span>
                <span class="n">mass_action_model</span> <span class="o">=</span> <span class="bp">False</span>
    
        <span class="k">if</span> <span class="n">mass_action_model</span><span class="p">:</span>
            <span class="n">GF</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()))</span>
            <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
            
            <span class="n">involved_species</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reactants</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfReactions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">temp2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reaction</span><span class="o">.</span><span class="n">reactants</span><span class="p">:</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                    <span class="n">temp2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reaction</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">involved_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">reactants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span>
                    
            <span class="n">species_to_reactions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reactants</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">species_map</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">species_to_reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            

            <span class="n">reaction_to_reaction</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfReactions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reaction</span><span class="o">.</span><span class="n">reactants</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">species_to_reactions</span><span class="p">[</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">+</span><span class="n">species_to_reactions</span><span class="p">[</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span>
                
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reaction</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">species_to_reactions</span><span class="p">[</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">+</span> <span class="n">species_to_reactions</span><span class="p">[</span><span class="n">species_map</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span>
                
                <span class="n">temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
                <span class="n">reaction_to_reaction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            
            <span class="c"># Populate G</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species_to_reactions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                    <span class="n">GF</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reaction_to_reaction</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reac</span><span class="p">:</span>
                    <span class="n">GF</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                
        <span class="k">try</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">GF</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">GF</span>

        <span class="k">return</span> <span class="n">G</span>

</div>
<div class="viewcode-block" id="URDMEModel.timespan"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.timespan">[docs]</a>    <span class="k">def</span> <span class="nf">timespan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tspan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the time span of simulation. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="n">tspan</span>

</div>
    <span class="k">def</span> <span class="nf">_initialize_default_subdomain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot; Create a default subdomain function. The default is all voxels belong</span>
<span class="sd">             to subdomain 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subdomain</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">MeshFunction</span><span class="p">(</span><span class="s">&quot;size_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">subdomain</span><span class="o">.</span><span class="n">set_all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_subdomain</span><span class="p">(</span><span class="n">subdomain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_species_to_subdomains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the species mapping to subdomains. The default</span>
<span class="sd">            is that a species is active in all the defined subdomains.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># If no subdomain function has been set by the user,</span>
        <span class="c"># we need to create a default subdomain here.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_default_subdomain</span><span class="p">()</span>

        <span class="c"># The unique elements of the subdomain MeshFunctions</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">subdomain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sds</span> <span class="o">=</span> <span class="n">sds</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">array</span><span class="p">())</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>

        <span class="c"># This explicit typecast is necessary for UFL not to choke on the subdomain ids.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sds</span><span class="p">):</span>
            <span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>

        <span class="c"># This conversion is necessary for UFL not to choke on the subdomain ids.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sds</span><span class="p">):</span>
            <span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># If a species is not present as key in the species_to_subdomain mapping,</span>
        <span class="c"># we label it as active in all subdomains</span>
        <span class="k">for</span> <span class="n">spec_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">sds</span>


<div class="viewcode-block" id="URDMEModel.restrict"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.restrict">[docs]</a>    <span class="k">def</span> <span class="nf">restrict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">subdomains</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Restrict the diffusion of a species to a subdomain. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdomains</span>


</div>
<div class="viewcode-block" id="URDMEModel.set_subdomain_vector"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.set_subdomain_vector">[docs]</a>    <span class="k">def</span> <span class="nf">set_subdomain_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Explicitly set the subdomain vector from an array. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd_initialied</span> <span class="o">=</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="URDMEModel.get_subdomain_vector"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.get_subdomain_vector">[docs]</a>    <span class="k">def</span> <span class="nf">get_subdomain_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdomains</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Create the &#39;sd&#39; vector. &#39;subdomains&#39; is a dolfin FacetFunction,</span>
<span class="sd">            and if no subdomain input is specified, they voxels default to</span>
<span class="sd">            subdomain 1. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd_initialied</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span>
        
        
        <span class="c"># We need to make sure that the highest dimension is applied</span>
        <span class="c"># first, otherwise the cell level will overwrite all markings</span>
        <span class="c"># applied on boundaries.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;xmesh&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="c"># TODO: Support arbitrary sd-numbers and more than one subdomain</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="n">subdomains</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">sd</span>
            <span class="k">print</span> <span class="n">subdomains</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">subdomain</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># If we define subdomains on vertex, ONLY use those.</span>
                    <span class="c"># Then it is a direct copy to the sd</span>
                    <span class="k">for</span> <span class="n">ndx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdomain</span><span class="p">):</span>
                        <span class="n">sd</span><span class="p">[</span><span class="n">ndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Map all facet labels to vertex labels</span>
                    <span class="n">tovertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">()(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subdomain</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
                        <span class="k">for</span> <span class="n">vtx</span> <span class="ow">in</span> <span class="n">tovertex</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">subdomain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># TODO: Temporary hack to fix issue with Gmesh facet_region files.</span>
                                <span class="n">sd</span><span class="p">[</span><span class="n">vtx</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdomain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">sd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd_initialied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span>
</div>
<div class="viewcode-block" id="URDMEModel.initialize_initial_condition"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.initialize_initial_condition">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_initial_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create all-zeros inital condition matrix. &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nv</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="URDMEModel.create_extended_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.create_extended_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">create_extended_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extend the primary mesh with information about the degrees of freedom. &quot;&quot;&quot;</span>

        <span class="n">xmesh</span> <span class="o">=</span> <span class="n">URDMEXmesh</span><span class="p">()</span>
        <span class="c"># Construct a species map (dict mapping model species name to an integer index)</span>
        <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
        <span class="c"># Initialize the function spaces and dof maps.</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">name</span>
            <span class="n">spec_index</span> <span class="o">=</span> <span class="n">species_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
            <span class="n">xmesh</span><span class="o">.</span><span class="n">function_space</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">()</span>
            <span class="n">xmesh</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="n">xmesh</span><span class="o">.</span><span class="n">function_space</span><span class="p">[</span><span class="n">spec_name</span><span class="p">])</span>
            <span class="n">xmesh</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">)</span> <span class="o">*</span> <span class="n">xmesh</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">+</span> <span class="n">spec_index</span>
            <span class="n">xmesh</span><span class="o">.</span><span class="n">dof_to_vertex_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">dof_to_vertex_map</span><span class="p">(</span><span class="n">xmesh</span><span class="o">.</span><span class="n">function_space</span><span class="p">[</span><span class="n">spec_name</span><span class="p">])</span>
    

        <span class="n">xmesh</span><span class="o">.</span><span class="n">vertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span> <span class="o">=</span> <span class="n">xmesh</span>


    <span class="c"># Some utility routines to set initial conditions</span></div>
<div class="viewcode-block" id="URDMEModel.set_initial_condition_scatter"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.set_initial_condition_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_condition_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_init</span><span class="p">,</span> <span class="n">subdomains</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Scatter an initial number of molecules over the voxels in a subdomain. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&quot;u0&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_initial_condition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;xmesh&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_species_to_subdomains</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_subdomain_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">spec_init</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">subdomains</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>

            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">name</span>
            <span class="n">num_spec</span> <span class="o">=</span> <span class="n">spec_init</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
            <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
            <span class="n">specindx</span> <span class="o">=</span> <span class="n">species_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>

            <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sd</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">ltab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ltab</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelException</span><span class="p">(</span><span class="s">&quot;set_initial_condition_scatter: No voxel in the given subdomains &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">subdomains</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, check subdomain marking.&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_spec</span><span class="p">):</span>
                <span class="n">vtx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ltab</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">vtx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">specindx</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="URDMEModel.set_initial_condition_distribute_uniformly"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.set_initial_condition_distribute_uniformly">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_condition_distribute_uniformly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_init</span><span class="p">,</span> <span class="n">subdomains</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Place the same number of molecules of the species in each voxel. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;u0&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_initial_condition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;xmesh&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_species_to_subdomains</span><span class="p">()</span>

        <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
        <span class="n">num_voxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">spec_init</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subdomains</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subdomains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
            <span class="n">num_spec</span> <span class="o">=</span> <span class="n">spec_init</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
            <span class="n">specindx</span> <span class="o">=</span> <span class="n">species_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_voxels</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">ndx</span><span class="p">]</span> <span class="ow">in</span> <span class="n">subdomains</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">specindx</span><span class="p">,</span> <span class="n">ndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spec</span>
    
    </div>
<div class="viewcode-block" id="URDMEModel.set_initial_condition_place_near"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.set_initial_condition_place_near">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_condition_place_near</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_init</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Place all molecules of kind species in the voxel nearest a given point. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;u0&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_initial_condition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;xmesh&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_voxels</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>


        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">spec_init</span><span class="p">:</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span>
            <span class="n">num_spec</span> <span class="o">=</span> <span class="n">spec_init</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>

            <span class="c"># Find the voxel with center (vertex) nearest to the point</span>
            <span class="n">reppoint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="o">-</span><span class="n">reppoint</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
            <span class="n">specindx</span> <span class="o">=</span> <span class="n">species_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
            <span class="c">#dofind = self.xmesh.vertex_to_dof_map[spec_name][ix]</span>
            <span class="c">#ix = (dofind - specindx) / len(species_map)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">specindx</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spec</span>


</div>
<div class="viewcode-block" id="URDMEModel.create_system_matrix"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.create_system_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">create_system_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the system (diffusion) matrix for input to the URDME solvers. The matrix</span>
<span class="sd">            is built by concatenating the individually assembled matrices for each of the species,</span>
<span class="sd">            and multiplying with the lumped mass matrix (which define the volume of the voxels).</span>

<span class="sd">            Negative off-diagonal elements in the matrix are set to zero, and the diagonal is renormalized</span>
<span class="sd">            in order to assure that the returned matrix is a Markov transition matrix.</span>

<span class="sd">            Returns a dictionary containing the volumes of the subvolumes, the system diffusion matrix</span>
<span class="sd">            and the fraction of the mass of the negative off-diagonal elements that has been filtered out.</span>

<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c"># Check if the individual stiffness and mass matrices (per species) have been assembled, otherwise assemble them.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness_matrices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stiffness_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness_matrices</span>
            <span class="n">mass_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelException</span><span class="p">(</span><span class="s">&quot;This model has no mesh, can not create system matrix.&quot;</span><span class="p">)</span>
            <span class="n">matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stiffness_matrices</span> <span class="o">=</span> <span class="n">matrices</span><span class="p">[</span><span class="s">&#39;K&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrices</span> <span class="o">=</span> <span class="n">matrices</span><span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">]</span>
            <span class="n">stiffness_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stiffness_matrices</span>
            <span class="n">mass_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrices</span>

        <span class="c"># Make a dok matrix of dimension (Ndofs,Ndofs) for easier manipulatio</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Mspecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Mspecies</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelException</span><span class="p">(</span><span class="s">&quot;The model has no species, can not create system matrix.&quot;</span><span class="p">)</span>
        <span class="c"># Use dolfin &#39;dof&#39; number of voxels, not the number of verticies</span>
        <span class="n">Nvoxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_dof_voxels</span><span class="p">()</span>
        <span class="n">Ndofs</span> <span class="o">=</span> <span class="n">Nvoxels</span><span class="o">*</span><span class="n">Mspecies</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="n">Ndofs</span><span class="p">,</span> <span class="n">Ndofs</span><span class="p">))</span>

        <span class="c"># Create the volume vector by lumping the mass matrices</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ndofs</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">xmesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span>

        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="n">mass_matrices</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

            <span class="c">#dof2vtx = xmesh.dof_to_vertex_map[species]</span>
            <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">SM</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">vals</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
            <span class="n">vols</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_map</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vols</span><span class="p">)):</span>
                <span class="c">#vx = dof2vtx[j]  # need to use dof ordering</span>
                <span class="n">vx</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">dof</span> <span class="o">=</span> <span class="n">Mspecies</span><span class="o">*</span><span class="n">vx</span><span class="o">+</span><span class="n">spec</span>
                <span class="n">vol</span><span class="p">[</span><span class="n">dof</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            
        <span class="c"># This is necessary in order for the array to have the right dimension (Ndofs,1)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c"># Assemble one big matrix from the indiviudal stiffness matrices. Multiply by the inverse of</span>
        <span class="c"># the lumped mass matrix, filter out any entries with the wrong sign and renormalize the columns.</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">positive_mass</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_mass</span> <span class="o">=</span> <span class="mf">0.0</span>


        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subdomain_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="p">)</span>
        <span class="n">sd_vec_dof</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_dof_voxels</span><span class="p">())</span>
        <span class="n">vertex_to_dof</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">ndx</span><span class="p">,</span> <span class="n">sd_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sd</span><span class="p">):</span>
            <span class="n">sd_vec_dof</span><span class="p">[</span><span class="n">vertex_to_dof</span><span class="p">[</span><span class="n">ndx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sd_val</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">sd_vec_dof</span>

        <span class="k">for</span> <span class="n">species</span><span class="p">,</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">stiffness_matrices</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

            <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
            <span class="n">Kcrs</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">vals</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
            <span class="n">Kdok</span> <span class="o">=</span> <span class="n">Kcrs</span><span class="o">.</span><span class="n">todok</span><span class="p">()</span>

            <span class="c">#dof2vtx = xmesh.dof_to_vertex_map[species]</span>

            <span class="k">for</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">Kdok</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">ind</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ir</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ij</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c"># Use Dolfin dof ordering</span>
                <span class="c"># Depricated: Permutation to make the matrix ordering match that of sd, u0. (Dolfin dof -&gt; URDME dof)</span>
                <span class="c">#ir = dof2vtx[ind[0]]</span>
                <span class="c">#ij = dof2vtx[ind[1]]</span>

                <span class="n">val</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ir</span> <span class="o">!=</span> <span class="n">ij</span><span class="p">:</span>

                    <span class="c"># Check if this is an edge that the species should diffuse along,</span>
                    <span class="c"># if not, set the diffusion coefficient along this edge to zero. This is</span>
                    <span class="c"># equivalent to how boundary species are handled in the current Matlab interface.</span>
                    <span class="k">if</span> <span class="n">sd</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">species</span><span class="p">]]:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">positive_mass</span> <span class="o">+=</span> <span class="n">val</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">total_mass</span> <span class="o">+=</span> <span class="n">val</span>

                <span class="c"># The volume can be zero, if the species is not active at the vertex (such as a 2D species at a 3D node)</span>
                <span class="k">if</span> <span class="n">vol</span><span class="p">[</span><span class="n">Mspecies</span><span class="o">*</span><span class="n">ij</span><span class="o">+</span><span class="n">spec</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vi</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vi</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="n">Mspecies</span><span class="o">*</span><span class="n">ij</span><span class="o">+</span><span class="n">spec</span><span class="p">]</span>
                
                <span class="n">S</span><span class="p">[</span><span class="n">Mspecies</span><span class="o">*</span><span class="n">ir</span><span class="o">+</span><span class="n">spec</span><span class="p">,</span> <span class="n">Mspecies</span><span class="o">*</span><span class="n">ij</span><span class="o">+</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span><span class="o">/</span><span class="n">vi</span>

            <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Convert to compressed column for compatibility with the URDME solvers.</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">tocsc</span><span class="p">()</span>

        <span class="c"># Renormalize the columns (may not sum to zero since elements may have been filtered out</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">sumcol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ndofs</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndofs</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">sumcol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span>

            <span class="n">D</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="o">-</span><span class="n">sumcol</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>        

        <span class="k">if</span> <span class="n">total_mass</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;vol&#39;</span><span class="p">:</span><span class="n">vol</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">:</span><span class="n">D</span><span class="p">,</span> <span class="s">&#39;relative_positive_mass&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;vol&#39;</span><span class="p">:</span><span class="n">vol</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">:</span><span class="n">D</span><span class="p">,</span> <span class="s">&#39;relative_positive_mass&#39;</span><span class="p">:</span><span class="n">positive_mass</span><span class="o">/</span><span class="n">total_mass</span><span class="p">}</span>

</div>
<div class="viewcode-block" id="URDMEModel.validate"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urdme_solver_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validate the model data structures.</span>

<span class="sd">            validate should be called prior to writing the model to the solver input file,</span>
<span class="sd">            since the solvers themselves do very limited error checking of the input.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">spec_name</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_to_subdomains</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ModelException</span><span class="p">(</span><span class="s">&quot;Subdomain number 0 is reserved. Please check your model.&quot;</span><span class="p">)</span>

        <span class="c"># Check that all the columns of the system matrix sums to zero (or close to zero). If not, it does</span>
        <span class="c"># not define a Markov process and the solvers might segfault or produce erraneous results.</span>
        <span class="n">colsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">colsum</span> <span class="o">=</span> <span class="n">colsum</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">maxcolsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">colsum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colsum</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">maxcolsum</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&quot;D&quot;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">InvalidSystemMatrixException</span><span class="p">(</span><span class="s">&quot;Invalid diffusion matrix. The sum of the columns does not sum to zero. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">maxcolsum</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">colsum</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">maxcolsum</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="URDMEModel.create_connectivity_matrix"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.create_connectivity_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">create_connectivity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assemble a connectivity matrix in CCS format. &quot;&quot;&quot;</span>
        
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">()</span>
        <span class="n">trial_function</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">test_function</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">a_K</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">dolfin</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">nabla_grad</span><span class="p">(</span><span class="n">trial_function</span><span class="p">),</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">nabla_grad</span><span class="p">(</span><span class="n">test_function</span><span class="p">))</span> <span class="o">*</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">dx</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">a_K</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="n">Kcrs</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">vals</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Kcrs</span>
</div>
<div class="viewcode-block" id="URDMEModel.get_solver_datastructure"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.get_solver_datastructure">[docs]</a>    <span class="k">def</span> <span class="nf">get_solver_datastructure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the datastructures needed by the URDME solvers.</span>

<span class="sd">           get_solver_datastructure() creates and populates a dictionary, urdme_solver_data,</span>
<span class="sd">           containing the mandatory input data structures of the core NSM solver in URDME</span>
<span class="sd">           that is derived from the model. The data strucyures are</span>

<span class="sd">           D    - the Diffusion matrix</span>
<span class="sd">           N    - the stochiometry matrix</span>
<span class="sd">           G    - the dependency graph</span>
<span class="sd">           vol  - the volume vector</span>
<span class="sd">           sd   - the subdomain vector</span>
<span class="sd">           data - the data vector</span>
<span class="sd">           u0   - the intial condition</span>

<span class="sd">           This data is also returned, unlike in the Matlab URDME interface</span>

<span class="sd">           p - the vertex coordinates</span>
<span class="sd">           K - a (Nvoxel x Nvoxel) connectivity matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">urdme_solver_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">num_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()</span>

        <span class="c"># Stoichimetric matrix</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_stoichiometric_matrix</span><span class="p">()</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
        <span class="c"># Dependency Graph</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dependency_graph</span><span class="p">()</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;G&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">G</span>

        <span class="c"># Volume vector</span>
        <span class="n">result</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">create_system_matrix</span><span class="p">()</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;vol&#39;</span><span class="p">]</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;dofvolumes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span>

        <span class="c">#TODO: Make use of all dofs values, requires modification of CORE URDME...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dofvol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">)]</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dofvol</span>
        
        <span class="n">D</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;D&#39;</span><span class="p">]</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
        
        <span class="c">#</span>
        <span class="n">num_dofvox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dofvol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Get vertex to dof ordering</span>
        <span class="n">vertex_to_dof</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">())</span>
        <span class="n">dof_to_vertex</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">dof_to_vertex_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">())</span>
        
        <span class="n">vertex_to_dof_to_vertex</span> <span class="o">=</span> <span class="n">dof_to_vertex</span><span class="p">[</span><span class="n">vertex_to_dof</span><span class="p">]</span>
        
        <span class="c"># Subdomain vector</span>
        <span class="c"># convert to dof ordering</span>
        <span class="n">sd_vec_dof</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dofvox</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ndx</span><span class="p">,</span> <span class="n">sd_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subdomain_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdomains</span><span class="p">)):</span>
            <span class="n">sd_vec_dof</span><span class="p">[</span><span class="n">vertex_to_dof</span><span class="p">[</span><span class="n">ndx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sd_val</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd_vec_dof</span>
        
        <span class="c"># Data vector. If not present in model, it defaults to a vector with all elements zero.</span>
        <span class="c"># convert to dof ordering</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dofvox</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfDataFunctions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfDataFunctions</span><span class="p">),</span> <span class="n">num_dofvox</span><span class="p">))</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ndf</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfDataFunctions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                    <span class="n">vox_coords</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">ndx</span><span class="p">])):</span>
                        <span class="n">vox_coords</span><span class="p">[</span><span class="n">cndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">ndx</span><span class="p">][</span><span class="n">cndx</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">ndf</span><span class="p">][</span><span class="n">vertex_to_dof</span><span class="p">[</span><span class="n">ndx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">vox_coords</span><span class="p">)</span>
            
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;u0&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_initial_condition</span><span class="p">()</span>

        <span class="c"># Initial Conditions, convert to dof ordering</span>
        <span class="n">u0_dof</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_species</span><span class="p">,</span> <span class="n">num_dofvox</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">vox_ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">()):</span>
            <span class="n">dof_ndx</span> <span class="o">=</span> <span class="n">vertex_to_dof</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span>
            <span class="c"># With periodic BCs the same dof_ndx voxel will get written to twice</span>
            <span class="c"># which may overwrite the value.  We need to check for this case.</span>
            <span class="k">if</span> <span class="n">vertex_to_dof_to_vertex</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vox_ndx</span><span class="p">:</span>
                <span class="n">vox_ndx2</span> <span class="o">=</span> <span class="n">vertex_to_dof_to_vertex</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">cndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_species</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx2</span><span class="p">]:</span>
                        <span class="n">u0_dof</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">dof_ndx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vox_ndx</span> <span class="o">&lt;</span> <span class="n">vox_ndx2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vox_ndx</span> <span class="o">&gt;</span> <span class="n">vox_ndx2</span><span class="p">:</span>
                        <span class="n">u0_dof</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">dof_ndx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Warning: the initial condition for species {0} in voxel {1} will be discarded due to periodic boundary conditions.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">cndx</span><span class="p">],</span> <span class="n">vox_ndx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_species</span><span class="p">):</span>
                    <span class="n">u0_dof</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">dof_ndx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">cndx</span><span class="p">,</span> <span class="n">vox_ndx</span><span class="p">]</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;u0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u0_dof</span>

        <span class="n">tspan</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;tspan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tspan</span>

        <span class="c"># Vertex coordinates</span>
        <span class="c"># convert to dof ordering</span>
        <span class="n">p_dof</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_dofvox</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">vox_ndx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_voxels</span><span class="p">()):</span>
            <span class="n">p_dof</span><span class="p">[</span><span class="n">vertex_to_dof</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">],:</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_dof</span>

        <span class="c"># Connectivity matrix</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_connectivity_matrix</span><span class="p">()</span>

        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;report&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">return</span> <span class="n">urdme_solver_data</span>

</div>
<div class="viewcode-block" id="URDMEModel.assemble"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.assemble">[docs]</a>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Assemble the mass and stiffness matrices using Dolfin.</span>

<span class="sd">            Returns: A dictionary containing two dictionaries, one for the stiffness matrices</span>
<span class="sd">            and one for the mass matrices. Those dictionaries has the species names as keys and</span>
<span class="sd">            the matrices are in CSR format.</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_extended_mesh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_species_to_subdomains</span><span class="p">()</span>

        <span class="n">function_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmesh</span><span class="o">.</span><span class="n">function_space</span>
        <span class="n">trial_functions</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">test_functions</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">stiffness_matrices</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">mass_matrices</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c"># The maximum dimension that a species is active on (currently not used)</span>
        <span class="n">maxdim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&gt;</span> <span class="n">maxdim</span><span class="p">:</span>
                <span class="n">maxdim</span> <span class="o">=</span> <span class="n">dim</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="n">trial_functions</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">function_space</span><span class="p">[</span><span class="n">spec</span><span class="p">])</span>
            <span class="n">test_functions</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">function_space</span><span class="p">[</span><span class="n">spec</span><span class="p">])</span>


        <span class="n">weak_form_K</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weak_form_M</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">ndofs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Set up the forms</span>
        <span class="k">for</span> <span class="n">spec_name</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c"># Find out what subdomains this species is active on</span>
            <span class="n">weak_form_K</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">nabla_grad</span><span class="p">(</span><span class="n">trial_functions</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]),</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">nabla_grad</span><span class="p">(</span><span class="n">test_functions</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]))</span><span class="o">*</span><span class="n">dolfin</span><span class="o">.</span><span class="n">dx</span>
            <span class="n">weak_form_M</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial_functions</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span><span class="o">*</span><span class="n">test_functions</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span><span class="o">*</span><span class="n">dolfin</span><span class="o">.</span><span class="n">dx</span>

        <span class="c"># Assemble the matrices</span>
        <span class="k">for</span> <span class="n">spec_name</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stiffness_matrices</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">weak_form_K</span><span class="p">[</span><span class="n">spec_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ndofs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ndofs</span> <span class="o">=</span> <span class="n">stiffness_matrices</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">set_num_dof_voxels</span><span class="p">(</span><span class="n">ndofs</span><span class="p">)</span>
            
            <span class="c"># We cannot include the diffusion constant in the assembly, dolfin does not seem to deal well</span>
            <span class="c"># with small diffusion constants (drops small elements)</span>
            <span class="n">stiffness_matrices</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">diffusion_constant</span> <span class="o">*</span> <span class="n">stiffness_matrices</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
            <span class="n">mass_matrices</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">weak_form_M</span><span class="p">[</span><span class="n">spec_name</span><span class="p">])</span>


        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;K&#39;</span><span class="p">:</span><span class="n">stiffness_matrices</span><span class="p">,</span> <span class="s">&#39;M&#39;</span><span class="p">:</span><span class="n">mass_matrices</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="URDMEModel.run"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEModel.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_trajectories</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s">&#39;nsm&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Simulate the model.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            solver: A str or class type that is a subclass of URDMESolver.  Default: NSM solver.</span>
<span class="sd">            number_of_trajectories: How many trajectories should be run.</span>
<span class="sd">            seed: An int, the random seed given to the solver.</span>
<span class="sd">            report_level: An int, Level of output from the solver: 0, 1, or 2. Default: 0.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A URDMEResult object with the results of the simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c">#If solver is a subclass of URDMESolver, use it directly.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">))</span> <span class="ow">and</span>  <span class="nb">issubclass</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">URDMESolver</span><span class="p">):</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="n">report_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;nsm&#39;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">nsmsolver</span> <span class="kn">import</span> <span class="n">NSMSolver</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">NSMSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="n">report_level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Unknown solver: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;solver argument to urdme() must be a string or a URDMESolver class object.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">number_of_trajectories</span><span class="o">=</span><span class="n">number_of_trajectories</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="URDMEMesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh">[docs]</a><span class="k">class</span> <span class="nc">URDMEMesh</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">Mesh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A URDME mesh extends the Dolfin mesh class. </span>

<span class="sd">        Provides wrappers around dolfins built-in simple geometries/mesh generation function.</span>
<span class="sd">        These following methods will all give regular meshes that will produce discretizations that are equivalent to Cartesian grids.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrained_domain</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">dolfin</span><span class="o">.</span><span class="n">Mesh</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_space</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_dof_voxels</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="URDMEMesh.add_periodic_boundary_condition"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.add_periodic_boundary_condition">[docs]</a>    <span class="k">def</span> <span class="nf">add_periodic_boundary_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a periodic boundary mapping object (a subclass of dolfin.SubDomain). &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrained_domain</span> <span class="o">=</span> <span class="n">domain</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_function_space"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_function_space">[docs]</a>    <span class="k">def</span> <span class="nf">get_function_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the FunctionSpace dolfin object for this mesh. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_space</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constrained_domain</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_space</span> <span class="o">=</span> <span class="n">fs</span>
            <span class="k">return</span> <span class="n">fs</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_num_voxels"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_num_voxels">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the number of voxels in the vertex ordering. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="URDMEMesh.set_num_dof_voxels"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.set_num_dof_voxels">[docs]</a>    <span class="k">def</span> <span class="nf">set_num_dof_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the number of voxels in the DOF ordering. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_dof_voxels</span> <span class="o">=</span> <span class="n">num</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_num_dof_voxels"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_num_dof_voxels">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_dof_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the number of voxels in the DOF ordering. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dof_voxels</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&#39;NumDofVoxels is not set&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_dof_voxels</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_voxels"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_voxels">[docs]</a>    <span class="k">def</span> <span class="nf">get_voxels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the (x,y,z) coordinate of each voxel. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="URDMEMesh.closest_vertex"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.closest_vertex">[docs]</a>    <span class="k">def</span> <span class="nf">closest_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get index of the vertex in the coordinate list closest to the point x. &quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_voxels</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">reppoint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords</span><span class="o">-</span><span class="n">reppoint</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ix</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_mesh_size"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_mesh_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_mesh_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Estimate of mesh size at each vertex. &quot;&quot;&quot;</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
        
        <span class="c"># Compute the circumradius of the cells</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">()):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">diameter</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c"># Compute the mean for each vertex based on all incident cells</span>
        <span class="n">vtx2cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">()(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span>
        <span class="n">vtxh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()):</span>
            <span class="n">v2c</span> <span class="o">=</span> <span class="n">vtx2cell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">indx</span> <span class="ow">in</span> <span class="n">v2c</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="n">cr</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">v2c</span><span class="p">)</span>
            <span class="n">vtxh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vtxh</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_normalized_coordinates"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_normalized_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">get_normalized_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return vertex coordinates centered at origin. &quot;&quot;&quot;</span>
        
        <span class="c"># Compute mesh centroid</span>
        <span class="n">vtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># Shift so the centroid is now origo</span>
        <span class="n">normalized_vtx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vtx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vtx</span><span class="p">):</span>
            <span class="n">normalized_vtx</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">centroid</span>

        <span class="k">return</span> <span class="n">normalized_vtx</span>
</div>
<div class="viewcode-block" id="URDMEMesh.get_scaled_normalized_coordinates"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_scaled_normalized_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">get_scaled_normalized_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return vertex coordinates scaled to the interval (-1,1) and centered at origin. &quot;&quot;&quot;</span>
        <span class="c"># Scale the verices so the max dimension is in the range (-1,1) to be compatible with the browser display</span>
        <span class="n">vtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
        <span class="n">maxvtx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">maxvtx</span>
        <span class="n">vtx</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="n">vtx</span>
        
        <span class="c"># Compute mesh centroid</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># Shift so the centroid is now origo</span>
        <span class="n">normalized_vtx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vtx</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vtx</span><span class="p">):</span>
            <span class="n">normalized_vtx</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">centroid</span>
        
        
        <span class="k">return</span> <span class="n">factor</span><span class="p">,</span> <span class="n">normalized_vtx</span>
    </div>
<div class="viewcode-block" id="URDMEMesh.get_scaled_coordinates"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.get_scaled_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">get_scaled_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return vertex coordinates scaled to the interval (-1,1). &quot;&quot;&quot;</span>
        <span class="c"># Scale the verices so the max dimension is in the range (-1,1) to be compatible with the browser display</span>
        <span class="n">vtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
        <span class="n">maxvtx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">vtx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">maxvtx</span>
        <span class="k">return</span> <span class="n">factor</span><span class="p">,</span> <span class="n">factor</span><span class="o">*</span><span class="n">vtx</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_unit_interval_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_unit_interval_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_unit_interval_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit Interval (1D) of with nx points in the axes. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">generate_interval_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>
    </div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_unit_square_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_unit_square_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_unit_square_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit Square (2D) of with nx, ny points in the respective axes. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">generate_square_mesh</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_unit_cube_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_unit_cube_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_unit_cube_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit Cube (3D) of with nx, ny, nz points in the respective axes. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">generate_cube_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="n">nz</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_interval_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_interval_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_interval_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interval (1D) of with nx points in the axes, and side length L. &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">IntervalMesh</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">URDMEMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">IntervalMeshPeriodicBoundary</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">periodic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_square_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_square_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_square_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit Square (2D) of with nx, ny points in the respective axes, and side length L. &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">RectangleMesh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">URDMEMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">SquareMeshPeriodicBoundary</span><span class="p">(</span><span class="n">Lx</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="n">L</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">periodic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.generate_cube_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.generate_cube_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">generate_cube_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit Cube (3D) of with nx, ny, nz points in the respective axes, and side length L. &quot;&quot;&quot;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">BoxMesh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">URDMEMesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">CubeMeshPeriodicBoundary</span><span class="p">(</span><span class="n">Lx</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">Lz</span><span class="o">=</span><span class="n">L</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">periodic</span><span class="p">,</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">add_periodic_boundary_condition</span><span class="p">(</span><span class="n">periodic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="URDMEMesh.read_dolfin_mesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.read_dolfin_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">read_dolfin_mesh</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Import a mesh in Dolfins native .xml format &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dolfin_mesh</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">URDMEMesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">=</span><span class="n">dolfin_mesh</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mesh</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MeshImportError</span><span class="p">(</span><span class="s">&quot;Failed to import mesh: &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="URDMEMesh.export_to_three_js"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEMesh.export_to_three_js">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_three_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return a Json string of the mesh in THREE Js format. </span>
<span class="sd">            </span>
<span class="sd">            If a colors list is specified, it should have the num_voxels entries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">document</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;formatVersion&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
        <span class="n">gfdg</span><span class="p">,</span><span class="n">vtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_normalized_coordinates</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># 2D</span>
            <span class="n">num_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">()</span>
            <span class="c"># This is a fix for the built-in 2D meshes that only have x,y-coordinates.</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vtx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">vtxx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vtx</span><span class="p">):</span>
                    <span class="n">vtxx</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vtx</span> <span class="o">=</span> <span class="n">vtxx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># 3D</span>
            <span class="n">num_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_facets</span><span class="p">()</span>

        <span class="n">materials</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span>
                     <span class="s">&quot;DbgColor&quot;</span> <span class="p">:</span> <span class="mi">15658734</span><span class="p">,</span>
                     <span class="s">&quot;DbgIndex&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&quot;DbgName&quot;</span> <span class="p">:</span> <span class="s">&quot;dummy&quot;</span><span class="p">,</span>
                     <span class="s">&quot;colorDiffuse&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">],</span>
                     <span class="p">}</span> <span class="p">]</span>
                     
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;materials&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">materials</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;vertices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vtx</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Default color is blue</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span>
        
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;colors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span>
        
        <span class="n">connectivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">()(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_elements</span><span class="p">):</span>
            <span class="n">face</span> <span class="o">=</span> <span class="n">connectivity</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">face</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Out of bounds&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
            <span class="n">faces</span> <span class="o">+=</span> <span class="p">([</span><span class="mi">128</span><span class="p">]</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;faces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span>
        
        <span class="c">#Test that we can index into vertices</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s">&quot;vertices&quot;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_ipython_display_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">jstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_to_three_js</span><span class="p">()</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;/data/three.js_templates/mesh.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">hstr</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;could note open template mesh.html&quot;</span><span class="p">)</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;###PYURDME_MESH_JSON###&#39;</span><span class="p">,</span><span class="n">jstr</span><span class="p">)</span>
        <span class="c"># Create a random id for the display div. This is to avioid multiple plots ending up in the same</span>
        <span class="c"># div in Ipython notebook</span>
        <span class="kn">import</span> <span class="nn">uuid</span>
        <span class="n">displayareaid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;###DISPLAYAREAID###&#39;</span><span class="p">,</span><span class="n">displayareaid</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div id=&quot;&#39;</span><span class="o">+</span><span class="n">displayareaid</span><span class="o">+</span><span class="s">&#39;&quot; class=&quot;cell&quot;&gt;&lt;/div&gt;&#39;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">    &lt;head&gt;</span>
<span class="s">        &lt;title&gt;PyURDME Result&lt;/title&gt; &lt;style&gt;canvas { width: 100%; height: 100% }&lt;/style&gt; &lt;/head&gt;</span>

<span class="s">        &lt;body&gt;</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="o">+</span><span class="n">hstr</span><span class="p">)</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;/body&gt;</span>

<span class="s">&lt;/html&gt;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="o">+</span><span class="n">hstr</span><span class="p">))</span>


</div>
<div class="viewcode-block" id="URDMEXmesh"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEXmesh">[docs]</a><span class="k">class</span> <span class="nc">URDMEXmesh</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Extended mesh object.</span>

<span class="sd">        Contains function spaces and dof mappings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_to_dof_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dof_to_vertex_map</span> <span class="o">=</span> <span class="p">{}</span>

</div>
<div class="viewcode-block" id="URDMEResult"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult">[docs]</a><span class="k">class</span> <span class="nc">URDMEResult</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Result object for a URDME simulation, extends the dict object. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">loaddata</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_is_loaded</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol_initialized</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">loaddata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_solution</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tspan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timespan</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">tspan</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_timespan</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;tspan does not match&quot;</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tspan</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="n">t</span><span class="p">)</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="n">t</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Species {0} does not match at t={1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;value error: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>


<div class="viewcode-block" id="URDMEResult.get_endtime_model"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.get_endtime_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_endtime_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a URDME model object with the initial conditions set to the final time point of the</span>
<span class="sd">            result object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;can not continue a result with no model&quot;</span><span class="p">)</span>
        <span class="c"># create a soft copy</span>
        <span class="n">model2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="c"># set the initial conditions </span>
        <span class="n">model2</span><span class="o">.</span><span class="n">u0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">u0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">):</span>
            <span class="n">model2</span><span class="o">.</span><span class="n">u0</span><span class="p">[</span><span class="n">s</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model2</span>

</div>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by pickle to get state when pickling. We need to read the contents of the</span>
<span class="sd">        output file since we can&#39;t pickel file objects. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">filecontents</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">((</span><span class="s">&quot;Error pickling model. Failed to read result file:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">state</span><span class="p">[</span><span class="s">&quot;filecontents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filecontents</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">((</span><span class="s">&quot;Failed to pickle URDMEResult:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">state</span>


    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used by pickle to set state when unpickling. &quot;&quot;&quot;</span>
        
        <span class="c"># If the object contains filecontents, write those to a new tmp file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filecontents</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;filecontents&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filecontents</span><span class="p">)</span>
            <span class="n">state</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Error unpickling model, could not recreate the solution file.&quot;</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_reorder_dof_to_voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">num_species</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reorder the colums of M from dof ordering to vertex ordering. &quot;&quot;&quot;</span>
        
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">()</span>
        <span class="n">v2d</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_timepoints</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_timepoints</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">num_vox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_species</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">num_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()</span>
        <span class="n">num_dofs</span> <span class="o">=</span> <span class="n">num_vox</span><span class="o">*</span><span class="n">num_species</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_timepoints</span><span class="p">,</span> <span class="n">num_dofs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vox_ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_vox</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_species</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">C</span><span class="p">[:,</span> <span class="n">vox_ndx</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">v2d</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">C</span><span class="p">[:,</span> <span class="n">vox_ndx</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:,</span> <span class="n">v2d</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="c">#traceback.print_stack()</span>
                    <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">print</span> <span class="s">&quot;C.shape: &quot;</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span>
                    <span class="k">print</span> <span class="s">&quot;M.shape: &quot;</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span>
                    <span class="k">print</span> <span class="s">&quot;num_timepoints: &quot;</span><span class="p">,</span> <span class="n">num_timepoints</span>
                    <span class="k">print</span> <span class="s">&quot;vox_ndx={0},num_species={1},cndx={2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vox_ndx</span><span class="p">,</span><span class="n">num_species</span><span class="p">,</span><span class="n">cndx</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;v2d[vox_ndx]={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v2d</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">])</span>
                    <span class="k">print</span> <span class="s">&quot;vox_ndx*num_species+cndx={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vox_ndx</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;v2d[vox_ndx]*num_species+cndx={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v2d</span><span class="p">[</span><span class="n">vox_ndx</span><span class="p">]</span><span class="o">*</span><span class="n">num_species</span><span class="o">+</span><span class="n">cndx</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">C</span>

<div class="viewcode-block" id="URDMEResult.read_solution"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.read_solution">[docs]</a>    <span class="k">def</span> <span class="nf">read_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read the tspan and U matrix into memory. &quot;&quot;&quot;</span>
        
        <span class="n">resultfile</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">resultfile</span><span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        
        <span class="n">tspan</span> <span class="o">=</span> <span class="n">resultfile</span><span class="p">[</span><span class="s">&#39;tspan&#39;</span><span class="p">]</span>
        <span class="n">tspan</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tspan</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">resultfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c"># Reorder the dof from dof ordering to voxel ordering</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reorder_dof_to_voxel</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="n">tspan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_is_loaded</span> <span class="o">=</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="URDMEResult.get_timespan"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.get_timespan">[docs]</a>    <span class="k">def</span> <span class="nf">get_timespan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resultfile</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">tspan</span> <span class="o">=</span> <span class="n">resultfile</span><span class="p">[</span><span class="s">&#39;tspan&#39;</span><span class="p">]</span>
            <span class="n">tspan</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tspan</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">resultfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span> <span class="o">=</span> <span class="n">tspan</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tspan</span>
    </div>
<div class="viewcode-block" id="URDMEResult.get_species"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.get_species">[docs]</a>    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="n">concentration</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a slice (view) of the output matrix U that contains one species for the timepoints</span>
<span class="sd">            specified by the time index array. The default is to return all timepoints. </span>
<span class="sd">            </span>
<span class="sd">            Data is loaded by slicing directly in the hdf5 dataset, i.e. it the entire</span>
<span class="sd">            content of the file is not loaded in memory and the U matrix </span>
<span class="sd">            is never added to the object.</span>
<span class="sd">            </span>
<span class="sd">            if concentration is False (default), the integer, raw, trajectory data is returned,</span>
<span class="sd">            if set to True, the concentration (=copy_number/volume) is returned.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">species</span>
        
        <span class="n">species_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_species_map</span><span class="p">()</span>
        <span class="n">num_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()</span>
        <span class="n">spec_indx</span> <span class="o">=</span> <span class="n">species_map</span><span class="p">[</span><span class="n">spec_name</span><span class="p">]</span>
        
        <span class="n">resultfile</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="c">#Ncells = self.model.mesh.num_vertices()  # Need dof ordering numVoxels</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">resultfile</span><span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">]</span>
        <span class="n">Ncells</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">num_species</span>
        
        <span class="k">if</span> <span class="n">timepoints</span>  <span class="o">==</span>  <span class="s">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">Uslice</span><span class="o">=</span> <span class="n">U</span><span class="p">[:,(</span><span class="n">spec_indx</span><span class="o">*</span><span class="n">Ncells</span><span class="p">):(</span><span class="n">spec_indx</span><span class="o">*</span><span class="n">Ncells</span><span class="o">+</span><span class="n">Ncells</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Uslice</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">timepoints</span><span class="p">,(</span><span class="n">spec_indx</span><span class="o">*</span><span class="n">Ncells</span><span class="p">):(</span><span class="n">spec_indx</span><span class="o">*</span><span class="n">Ncells</span><span class="o">+</span><span class="n">Ncells</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">concentration</span><span class="p">:</span>
            <span class="n">Uslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copynumber_to_concentration</span><span class="p">(</span><span class="n">Uslice</span><span class="p">)</span>
        
        <span class="c"># Reorder the dof from dof ordering to voxel ordering</span>
        <span class="n">Uslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reorder_dof_to_voxel</span><span class="p">(</span><span class="n">Uslice</span><span class="p">,</span> <span class="n">num_species</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c"># Make sure we return 1D slices as flat arrays</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Uslice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Uslice</span> <span class="o">=</span> <span class="n">Uslice</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">resultfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Uslice</span>

            </div>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="s">&quot;Cannot set &#39;</span><span class="si">%s</span><span class="s">&#39;, cls attribute already exists&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">k</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setupitems__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;sol&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_sol</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s">&#39;U&#39;</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;tspan&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_is_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;This result object has no data file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_solution</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setupitems__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Object has no attribute {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setupitems__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Object has no attribute {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deconstructor. &quot;&quot;&quot;</span>
            <span class="c">#   if not self.data_is_loaded:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Clean up data file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">#print &quot;URDMEResult.__del__: Could not delete result file&#39;{0}&#39;: {1}&quot;.format(self.filename, e)</span>
            <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">_initialize_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the sol variable. This is a helper function for export_to_vtk(). &quot;&quot;&quot;</span>
        
        <span class="c"># Create Dolfin Functions for all the species</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;URDMEResult.model must be set before the sol attribute can be accessed.&quot;</span><span class="p">)</span>
        <span class="n">numvox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">()</span>
        <span class="n">vertex_to_dof_map</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">dof_to_vertex_map</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">dof_to_vertex_map</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

        <span class="c"># The result is loaded in dolfin Functions, one for each species and time point</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">):</span>

            <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
            <span class="n">spec_name</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">name</span>

            <span class="n">spec_sol</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspan</span><span class="p">):</span>
                
                <span class="n">func</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
                <span class="n">func_vector</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>

                <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numvox</span><span class="p">):</span>
                    <span class="n">ix</span>  <span class="o">=</span> <span class="n">vertex_to_dof_map</span><span class="p">[</span><span class="n">voxel</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">func_vector</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">voxel</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dofvol</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>

                    <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;func_vector.size(): &quot;</span><span class="p">,</span> <span class="n">func_vector</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                        <span class="k">print</span> <span class="s">&quot;dolfvox: &quot;</span><span class="p">,</span><span class="n">dolfvox</span>
                        <span class="k">print</span> <span class="s">&quot;S.shape: &quot;</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">print</span> <span class="s">&quot;voxel: &quot;</span><span class="p">,</span><span class="n">voxel</span>
                        <span class="k">print</span> <span class="s">&quot;vertex_to_dof_map[voxel]&quot;</span><span class="p">,</span> <span class="n">vertex_to_dof_map</span><span class="p">[</span><span class="n">voxel</span><span class="p">]</span>
                        <span class="k">print</span> <span class="s">&quot;self.model.dofvol.shape: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dofvol</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">raise</span> <span class="n">e</span>

                <span class="n">spec_sol</span><span class="p">[</span><span class="n">time</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>

            <span class="n">sol</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_sol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol</span> <span class="o">=</span> <span class="n">sol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol_initialized</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">sol</span>
    
    
<div class="viewcode-block" id="URDMEResult.export_to_vtk"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.export_to_vtk">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_vtk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dump the trajectory to a collection of vtk files in the folder folder_name (created if non-existant). &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_sol</span><span class="p">()</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&quot;mkdir&quot;</span><span class="p">,</span> <span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">])</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">())</span>
        <span class="n">func_vector</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">folder_name</span><span class="o">+</span><span class="s">&quot;/trajectory.pvd&quot;</span><span class="p">)</span>
        <span class="n">numvox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_dof_voxels</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspan</span><span class="p">):</span>
            <span class="n">solvector</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">time</span><span class="p">])</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numvox</span><span class="p">):</span>
                <span class="n">func_vector</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="n">solvector</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span>
            <span class="n">fd</span> <span class="o">&lt;&lt;</span> <span class="n">func</span>
</div>
<div class="viewcode-block" id="URDMEResult.export_to_xyx"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.export_to_xyx">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_xyx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">file_format</span><span class="o">=</span><span class="s">&quot;VMD&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Dump the solution attached to a model as a xyz file. This format can be</span>
<span class="sd">            read by e.g. VMD, Jmol and Paraview. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;No solution found in the model.&quot;</span><span class="p">)</span>

        <span class="c">#outfile = open(filename,&quot;w&quot;)</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
        <span class="n">Ndofs</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Mspecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">)</span>
        <span class="n">Ncells</span> <span class="o">=</span> <span class="n">Ndofs</span> <span class="o">/</span> <span class="n">Mspecies</span>

        <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_voxels</span><span class="p">()</span>
        <span class="n">coordinatestr</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s">&quot;VMD&quot;</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">filestr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspan</span><span class="p">):</span>
                <span class="n">number_of_atoms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">filestr</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">number_of_atoms</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;timestep &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; time &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncells</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">Mspecies</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]):</span>
                            <span class="c"># Sample a random position in a sphere of radius computed from the voxel volume</span>
                            <span class="c"># TODO: Sample volume</span>
                            <span class="n">linestr</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coordinatestr</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="n">filestr</span> <span class="o">+=</span> <span class="n">linestr</span>

            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filestr</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s">&quot;ParaView&quot;</span><span class="p">:</span>
            <span class="n">foldername</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">foldername</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspan</span><span class="p">):</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">foldername</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">number_of_atoms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">filestr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">filestr</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">number_of_atoms</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&quot;timestep &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; time &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncells</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">Mspecies</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]):</span>
                            <span class="n">linestr</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coordinatestr</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="n">filestr</span> <span class="o">+=</span> <span class="n">linestr</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filestr</span><span class="p">)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="URDMEResult.export_to_particle_js"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.export_to_particle_js">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_particle_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">species</span><span class="p">,</span><span class="n">time_index</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;/data/three.js_templates/particles.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="n">factor</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_scaled_normalized_coordinates</span><span class="p">()</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">is3d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vtxx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">vtxx</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">vtxx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is3d</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_mesh_size</span><span class="p">()</span>
        
        <span class="n">x</span><span class="o">=</span><span class="p">[];</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[];</span>
        <span class="n">z</span><span class="o">=</span><span class="p">[];</span>
        <span class="n">c</span><span class="o">=</span><span class="p">[];</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">total_num_particles</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="s">&quot;yellow&quot;</span><span class="p">,</span> <span class="s">&quot;green&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">species</span><span class="p">):</span>
            
            <span class="n">timeslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c">#timeslice = US[time_index,:]</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">timeslice</span><span class="p">)</span>
            <span class="n">total_num_particles</span> <span class="o">+=</span> <span class="n">ns</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particles</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeslice</span><span class="p">):</span>
                <span class="c"># &quot;Radius&quot; of voxel</span>
                <span class="n">hix</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span>
                <span class="n">hiy</span> <span class="o">=</span> <span class="n">hix</span><span class="p">;</span>
                <span class="n">hiz</span> <span class="o">=</span> <span class="n">hix</span><span class="o">*</span><span class="n">is3d</span>
                
                <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">particles</span><span class="p">)):</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">hix</span><span class="p">))</span>
                    <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">hiy</span><span class="p">))</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">hiz</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">reaction_radius</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                    
                    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__NUM__MOLECULES__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_num_particles</span><span class="p">))</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__X__&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__Y__&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__Z__&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__COLOR__&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__RADIUS__&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>


        <span class="k">return</span> <span class="n">docstr</span>

</div>
<div class="viewcode-block" id="URDMEResult.export_to_three_js"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.export_to_three_js">[docs]</a>    <span class="k">def</span> <span class="nf">export_to_three_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a json serialized document that can </span>
<span class="sd">            be read and visualized by three.js.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solution_colors</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="n">time_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">export_to_three_js</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_copynumber_to_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">copy_number_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Scale compy numbers to concentrations (in unit mol/volume),</span>
<span class="sd">            where the volume unit is defined by the user input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_function_space</span><span class="p">()</span>
        <span class="n">v2d</span> <span class="o">=</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">vertex_to_dof_map</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">copy_number_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">scaled_sol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">scaled_sol</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">copy_number_data</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">scaled_sol</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">timeslice</span> <span class="o">=</span> <span class="n">scaled_sol</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeslice</span><span class="p">):</span>
                <span class="n">scaled_sol</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">6.022e23</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dofvol</span><span class="p">[</span><span class="n">v2d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">scaled_sol</span>


    <span class="k">def</span> <span class="nf">_compute_solution_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">species</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a color list for species at time. &quot;&quot;&quot;</span>
        
        <span class="n">timeslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="n">time_index</span><span class="p">,</span> <span class="n">concentration</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib.cm</span>
        
        <span class="c"># Get RGB color map proportinal to the concentration.</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">()</span>
        <span class="n">crgba</span><span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">timeslice</span><span class="p">,</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                                     
        <span class="c"># Convert RGB to HEX</span>
        <span class="n">colors</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">crgba</span><span class="p">:</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rgb_to_hex</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>

        <span class="c"># Convert Hex to Decimal</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">colors</span>

    <span class="k">def</span> <span class="nf">_rgb_to_hex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;0x</span><span class="si">%02x%02x%02x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">rgb</span>


<div class="viewcode-block" id="URDMEResult.display"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEResult.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">species</span><span class="p">,</span><span class="n">time_index</span><span class="p">):</span>

        <span class="n">jstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_to_three_js</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="n">time_index</span><span class="p">)</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;/data/three.js_templates/solution.html&quot;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">hstr</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;could note open template mesh.html&quot;</span><span class="p">)</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;###PYURDME_MESH_JSON###&#39;</span><span class="p">,</span><span class="n">jstr</span><span class="p">)</span>
        
        <span class="c"># Create a random id for the display div. This is to avioid multiple plots ending up in the same</span>
        <span class="c"># div in Ipython notebook</span>
        <span class="kn">import</span> <span class="nn">uuid</span>
        <span class="n">displayareaid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;###DISPLAYAREAID###&#39;</span><span class="p">,</span><span class="n">displayareaid</span><span class="p">)</span>
        
        <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div id=&quot;&#39;</span><span class="o">+</span><span class="n">displayareaid</span><span class="o">+</span><span class="s">&#39;&quot; class=&quot;cell&quot;&gt;&lt;/div&gt;&#39;</span>
        <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">html</span><span class="o">+</span><span class="n">hstr</span><span class="p">))</span>


</div></div>
<div class="viewcode-block" id="URDMESolver"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMESolver">[docs]</a><span class="k">class</span> <span class="nc">URDMESolver</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Abstract class for URDME solvers. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">solver_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sopts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">URDMEModel</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;URDMEsolver constructors must take a URDMEModel as an argument.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">URDMESolver</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Solver classes must be a subclass of URDMESolver.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;NAME&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Solver classes must implement a NAME attribute.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_compiled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">=</span> <span class="n">report_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="n">model_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_infile</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">sopts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span> <span class="o">=</span> <span class="n">sopts</span>

        <span class="c"># For the remote execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;/urdme&quot;</span>

        <span class="c">#print &quot;solver_path={0}&quot;.format(solver_path)</span>
        <span class="k">if</span> <span class="n">solver_path</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">solver_path</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">URDME_BUILD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span> <span class="o">+</span> <span class="s">&#39;/build/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">URDME_BUILD</span> <span class="o">=</span> <span class="n">solver_path</span> <span class="o">+</span> <span class="s">&#39;/build/&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;SOLVER_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_path</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the state of the solver, saves all instance variables</span>
<span class="sd">            and reads all the files necessary to compile the solver off</span>
<span class="sd">            of the file system and stores it in a separate state variable.</span>
<span class="sd">            If the solver model files is specified, it saves that too.</span>
<span class="sd">            This is used by Pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Save the instance variables</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c"># The model object is not picklabe due to the Swig-objects from Dolfin</span>
        <span class="c">#ret[&#39;vars&#39;][&#39;model&#39;] = None</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;vars&#39;</span><span class="p">][</span><span class="s">&#39;is_compiled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Create temp root</span>
        <span class="n">tmproot</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="c"># Get the propensity file</span>
        <span class="n">model_file</span> <span class="o">=</span> <span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s">&#39;_pyurdme_generated_model&#39;</span><span class="o">+</span> <span class="s">&#39;.c&#39;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;model_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_propensity_file</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">model_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">model_file</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># Get the solver source files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/include&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/src&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/src/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">)</span>
        <span class="c">#TODO: what if solverdir is not the same as URDME_ROOT ?</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span><span class="o">+</span><span class="s">&#39;/src/*.c &#39;</span><span class="o">+</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/src/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span><span class="o">+</span><span class="s">&#39;/src/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="o">+</span><span class="s">&#39;/*.* &#39;</span><span class="o">+</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/src/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span><span class="o">+</span><span class="s">&#39;/include/*.h &#39;</span><span class="o">+</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/include/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c">#TODO: get the include files from solvers not in the default path (none currently implement this).</span>
        <span class="c"># Get the Makefile</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/build&#39;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;cp &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">URDME_BUILD</span><span class="o">+</span><span class="s">&#39;Makefile.&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/build/Makefile.&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># Get the input file</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/model_input.mat&#39;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;input_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">input_file</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">report_level</span><span class="p">)</span>
        <span class="c">##</span>
        <span class="n">origwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tmproot</span><span class="p">)</span>
        <span class="n">tarname</span> <span class="o">=</span> <span class="n">tmproot</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="o">+</span><span class="s">&#39;.tar.gz&#39;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;tar -czf &#39;</span><span class="o">+</span><span class="n">tarname</span><span class="o">+</span><span class="s">&#39; src include build &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">model_file</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tarname</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;SolverFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">origwd</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmproot</span><span class="p">)</span>
        <span class="c"># return the state</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set all instance variables for the object, and create a unique temporary</span>
<span class="sd">            directory to store all the solver files.  URDME_BUILD is set to this dir,</span>
<span class="sd">            and is_compiled is always set to false.  This is used by Pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># 0. restore the instance variables</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;vars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c"># 1. create temporary directory = URDME_ROOT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">URDME_BUILD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="o">+</span><span class="s">&#39;/build/&#39;</span>
        <span class="n">origwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="p">)</span>
        <span class="n">tarname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="o">+</span><span class="s">&#39;.tar.gz&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tarname</span><span class="p">,</span> <span class="s">&#39;wd&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;SolverFiles&#39;</span><span class="p">])</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;tar -zxf &#39;</span><span class="o">+</span><span class="n">tarname</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">origwd</span><span class="p">)</span>
        <span class="c"># Model File</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;model_file&#39;</span><span class="p">]</span>
        <span class="c"># Input File</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="o">+</span><span class="s">&#39;/&#39;</span><span class="o">+</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;input_file&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deconstructor.  Removes the compiled solver.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_infile</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Could not delete &#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Could not delete &#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Could not delete &#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_urdme_root</span><span class="p">)</span>


<div class="viewcode-block" id="URDMESolver.serialize"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMESolver.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sopts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the datastructures needed by the the core URDME solvers to a .mat input file. &quot;&quot;&quot;</span>
        <span class="n">urdme_solver_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_solver_datastructure</span><span class="p">()</span>
        <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_level</span>
        <span class="k">if</span> <span class="n">sopts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;sopts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">urdme_solver_data</span><span class="p">[</span><span class="s">&#39;sopts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sopts</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">urdme_solver_data</span><span class="p">)</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">urdme_solver_data</span><span class="p">,</span> <span class="n">oned_as</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="URDMESolver.compile"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMESolver.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compile the model.&quot;&quot;&quot;</span>

        <span class="c"># Create a unique directory each time call to compile.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span> <span class="o">+</span> <span class="s">&#39;/.urdme/&#39;</span>
        <span class="c">#print &quot;URDMESolver.compile()  self.solver_dir={0}&quot;.format(self.solver_dir)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Compiling Solver&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Write the propensity file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s">&#39;_pyurdme_generated_model&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">prop_file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">propfilename</span> <span class="o">+</span> <span class="s">&#39;.c&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Creating propensity file {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop_file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_propensity_file</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">prop_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;cp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">propfilename</span> <span class="o">+</span> <span class="s">&#39;.c&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">cmd</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="c"># Build the solver</span>
        <span class="n">makefile</span> <span class="o">=</span> <span class="s">&#39;Makefile.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="s">&#39;cd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_base_dir</span> <span class="p">,</span> <span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;make&#39;</span><span class="p">,</span> <span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">URDME_BUILD</span> <span class="o">+</span> <span class="n">makefile</span><span class="p">,</span> <span class="s">&#39;URDME_ROOT=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">URDME_ROOT</span><span class="p">,</span> <span class="s">&#39;URDME_MODEL=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">propfilename</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;cmd: {0}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Error, execution of compilation raised an exception: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;cmd = {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Compilation of solver failed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">handle</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">print</span> <span class="n">handle</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Compilation of solver failed, return_code={0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">return_code</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">handle</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">print</span> <span class="n">handle</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">is_compiled</span> <span class="o">=</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="URDMESolver.run"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMESolver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_trajectories</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">loaddata</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run one simulation of the model.</span>

<span class="sd">        number_of_trajectories: How many trajectories should be run.</span>
<span class="sd">        seed: the random number seed (incimented by one for multiple runs).</span>
<span class="sd">        input_file: the filename of the solver input data file .</span>
<span class="sd">        loaddata: boolean, should the result object load the data into memory on creation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            URDMEResult object.</span>
<span class="sd">                or, if number_of_trajectories &gt; 1</span>
<span class="sd">            a list of URDMEResult objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">number_of_trajectories</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># Check if compiled, call compile() if not.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compiled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">input_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span><span class="p">):</span>
                <span class="c"># Get temporary input and output files</span>
                <span class="n">infile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                <span class="c"># Write the model to an input file in .mat format</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">infile</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">report_level</span><span class="p">)</span>
                <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">name</span>
                <span class="c">#self.delete_infile = True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span> <span class="o">=</span> <span class="n">input_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_infile</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;input file not found.&quot;</span><span class="p">)</span>

        <span class="c"># Execute the solver</span>
        <span class="k">for</span> <span class="n">run_ndx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_trajectories</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">urdme_solver_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">propfilename</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infile_name</span><span class="p">,</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">urdme_solver_cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="n">run_ndx</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;cmd: {0}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urdme_solver_cmd</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c">#stderr &amp; stdout to the terminal</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">urdme_solver_cmd</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">urdme_solver_cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Error, execution of solver raised an exception: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;urdme_solver_cmd = {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urdme_solver_cmd</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Solver execution failed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span>
                <span class="k">print</span> <span class="n">return_code</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">handle</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">handle</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">print</span> <span class="s">&quot;urdme_solver_cmd = {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urdme_solver_cmd</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Solver execution failed, return code = {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">return_code</span><span class="p">))</span>


            <span class="c">#Load the result from the hdf5 output file.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">URDMEResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loaddata</span><span class="o">=</span><span class="n">loaddata</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s">&quot;Status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Sucess&quot;</span>
                <span class="k">if</span> <span class="n">number_of_trajectories</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
        <span class="k">return</span> <span class="n">result_list</span>

</div>
<div class="viewcode-block" id="URDMESolver.create_propensity_file"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMESolver.create_propensity_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_propensity_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate the C propensity file that is used to compile the URDME solvers.</span>
<span class="sd">            Only mass action propensities are supported.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">template</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;/data/propensity_file_template.c&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">propfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">speciesdef</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfSpecies</span><span class="p">:</span>
            <span class="n">speciesdef</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">S</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="s">&quot;x[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">speciesdef</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">S</span> <span class="o">+</span> <span class="s">&quot;_INDEX &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__DEFINE_SPECIES__&quot;</span><span class="p">,</span> <span class="n">speciesdef</span><span class="p">)</span>

        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__NUMBER_OF_REACTIONS__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_num_reactions</span><span class="p">()))</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__NUMBER_OF_SPECIES__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_num_species</span><span class="p">()))</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__NUMBER_OF_VOXELS__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">get_num_voxels</span><span class="p">()))</span>

        <span class="c"># Create defines for the DataFunctions.</span>
        <span class="n">data_fn_str</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfDataFunctions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;DataFunction {0} does not have a name attributed defined.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">data_fn_str</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; data[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__DEFINE_DATA_FUNCTIONS__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_fn_str</span><span class="p">))</span>

        <span class="c"># Make sure all paramters are evaluated to scalars before we write them to the file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">resolve_parameters</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfParameters</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">+=</span> <span class="s">&quot;const double &quot;</span> <span class="o">+</span> <span class="n">p</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfParameters</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__DEFINE_PARAMETERS__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>


        <span class="c"># Reactions</span>
        <span class="n">funheader</span> <span class="o">=</span> <span class="s">&quot;double __NAME__(const int *x, double t, const double vol, const double *data, int sd)&quot;</span>
        <span class="c">#funheader = &quot;double __NAME__(const int *x, double t, const double vol, const double *data, int sd, int voxel, int *xx, const size_t *irK, const size_t *jcK, const double *prK)&quot;</span>

        <span class="n">funcs</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">funcinits</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">R</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">rname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">func</span> <span class="o">+=</span> <span class="n">funheader</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__NAME__&quot;</span><span class="p">,</span> <span class="n">rname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">func</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">propensity_function</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;if(&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;sd == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;||&quot;</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;sd == &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">restrict_to</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;When restricting reaction to subdomains, you must specify either a list or an int&quot;</span><span class="p">)</span>
                <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;){</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">func</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">listOfReactions</span><span class="p">[</span><span class="n">R</span><span class="p">]</span><span class="o">.</span><span class="n">propensity_function</span>

                <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">}else{&quot;</span>
                <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">return 0.0;}&quot;</span>


            <span class="n">func</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">}&quot;</span>
            <span class="n">funcs</span> <span class="o">+=</span> <span class="n">func</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span>
            <span class="n">funcinits</span> <span class="o">+=</span> <span class="s">&quot;    ptr[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;] = &quot;</span> <span class="o">+</span> <span class="n">rname</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__DEFINE_REACTIONS__&quot;</span><span class="p">,</span> <span class="n">funcs</span><span class="p">)</span>
        <span class="n">propfilestr</span> <span class="o">=</span> <span class="n">propfilestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__DEFINE_PROPFUNS__&quot;</span><span class="p">,</span> <span class="n">funcinits</span><span class="p">)</span>
        <span class="n">propfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">propfilestr</span><span class="p">)</span>
        <span class="n">propfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


</div></div>
<div class="viewcode-block" id="urdme"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.urdme">[docs]</a><span class="k">def</span> <span class="nf">urdme</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s">&#39;nsm&#39;</span><span class="p">,</span> <span class="n">solver_path</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; URDME solver interface.</span>

<span class="sd">        Similar to model.run() the urdme() function provides an interface that is backwards compatiable with the</span>
<span class="sd">        previous URDME implementation.</span>

<span class="sd">        After sucessful execution, urdme returns a URDMEResults object with the following members:</span>
<span class="sd">        U:         the raw copy number output in a matrix with dimension (Ndofs, num_time_points)</span>
<span class="sd">        tspan:     the time span vector containing the time points that corresponds to the columns in U</span>
<span class="sd">        status:    Sucess if the solver executed without error</span>
<span class="sd">        stdout:    the standard ouput stream from the call to the core solver</span>
<span class="sd">        stderr:    the standard error stream from the call to the core solver</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="c">#If solver is a subclass of URDMESolver, use it directly.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">))</span> <span class="ow">and</span>  <span class="nb">issubclass</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">URDMESolver</span><span class="p">):</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver_path</span><span class="p">,</span> <span class="n">report_level</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="n">model_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;nsm&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">nsmsolver</span> <span class="kn">import</span> <span class="n">NSMSolver</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">NSMSolver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver_path</span><span class="p">,</span> <span class="n">report_level</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="n">model_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;nem&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">nemsolver</span> <span class="kn">import</span> <span class="n">NEMSolver</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">NEMSolver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver_path</span><span class="p">,</span> <span class="n">report_level</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="n">model_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;Unknown solver: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">URDMEError</span><span class="p">(</span><span class="s">&quot;solver argument to urdme() must be a string or a URDMESolver class object.&quot;</span><span class="p">)</span>

    <span class="n">sol</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="n">input_file</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="URDMEDataFunction"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEDataFunction">[docs]</a><span class="k">class</span> <span class="nc">URDMEDataFunction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Abstract class used to constuct the URDME data vector. &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;URDMEDataFunction must have a &#39;name&#39;&quot;</span><span class="p">)</span>
        
<div class="viewcode-block" id="URDMEDataFunction.map"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEDataFunction.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; map() takes the coordinate &#39;x&#39; and returns a list of doubles.</span>
<span class="sd">        Args:</span>
<span class="sd">            x: a list of 3 ints.</span>
<span class="sd">        Returns:</span>
<span class="sd">            a list of floats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;URDMEDataFunction.map() not implemented.&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="MeshImportError"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.MeshImportError">[docs]</a><span class="k">class</span> <span class="nc">MeshImportError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Exception to raise when encourntering and error importing a mesh. &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="URDMEError"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.URDMEError">[docs]</a><span class="k">class</span> <span class="nc">URDMEError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ModelException"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.ModelException">[docs]</a><span class="k">class</span> <span class="nc">ModelException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="InvalidSystemMatrixException"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.InvalidSystemMatrixException">[docs]</a><span class="k">class</span> <span class="nc">InvalidSystemMatrixException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="IntervalMeshPeriodicBoundary"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.IntervalMeshPeriodicBoundary">[docs]</a><span class="k">class</span> <span class="nc">IntervalMeshPeriodicBoundary</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Subdomain for Periodic boundary conditions on a interval domain. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 1D domain from a to b. &quot;&quot;&quot;</span>
        <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

<div class="viewcode-block" id="IntervalMeshPeriodicBoundary.inside"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.IntervalMeshPeriodicBoundary.inside">[docs]</a>    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">((</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">))</span> <span class="ow">and</span> <span class="n">on_boundary</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IntervalMeshPeriodicBoundary.map"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.IntervalMeshPeriodicBoundary.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="SquareMeshPeriodicBoundary"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.SquareMeshPeriodicBoundary">[docs]</a><span class="k">class</span> <span class="nc">SquareMeshPeriodicBoundary</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Subdomain for Periodic boundary conditions on a square domain. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">=</span> <span class="n">Lx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span> <span class="o">=</span> <span class="n">Ly</span>

<div class="viewcode-block" id="SquareMeshPeriodicBoundary.inside"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.SquareMeshPeriodicBoundary.inside">[docs]</a>    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Left boundary is &quot;target domain&quot; G &quot;&quot;&quot;</span>
        <span class="c"># return True if on left or bottom boundary AND NOT on one of the two corners (0, 1) and (1, 0)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">((</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span>
                <span class="p">(</span><span class="ow">not</span> <span class="p">((</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))))</span> <span class="ow">and</span> <span class="n">on_boundary</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SquareMeshPeriodicBoundary.map"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.SquareMeshPeriodicBoundary.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; # Map right boundary G (x) to left boundary H (y) &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c"># near(x[1], 1)</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
</div></div>
<div class="viewcode-block" id="CubeMeshPeriodicBoundary"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.CubeMeshPeriodicBoundary">[docs]</a><span class="k">class</span> <span class="nc">CubeMeshPeriodicBoundary</span><span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Subdomain for Periodic boundary conditions on a cube domain. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Ly</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Lz</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">dolfin</span><span class="o">.</span><span class="n">SubDomain</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">=</span> <span class="n">Lx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span> <span class="o">=</span> <span class="n">Ly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span> <span class="o">=</span> <span class="n">Lz</span>

<div class="viewcode-block" id="CubeMeshPeriodicBoundary.inside"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.CubeMeshPeriodicBoundary.inside">[docs]</a>    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Left boundary is &quot;target domain&quot; G &quot;&quot;&quot;</span>
        <span class="c"># return True if on left or bottom boundary AND NOT on one of the two corners (0, 1) and (1, 0)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
                <span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="p">))</span>
                <span class="ow">and</span> <span class="n">on_boundary</span>
               <span class="p">)</span>
</div>
<div class="viewcode-block" id="CubeMeshPeriodicBoundary.map"><a class="viewcode-back" href="../../pyurdme.html#pyurdme.pyurdme.CubeMeshPeriodicBoundary.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; # Map right boundary G (x) to left boundary H (y) &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ly</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dolfin</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>



</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Command line interface to URDME. Execute URDME given a model file. &quot;&quot;&quot;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">PyURDME 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Brian Drawert, Andreas Hellander.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b3.
    </div>
  </body>
</html>