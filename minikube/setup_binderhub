#!/bin/bash

# Setup binderhub on a minikube cluster.
#
# This script assumes that you're using Docker Hub for the container registry
# and that you have an account setup there.
# See https://binderhub.readthedocs.io/en/latest/setup-registry.html

echo "Generating tokens..."
BINDER_TOKEN=$(openssl rand -hex 32)
PROXY_TOKEN=$(openssl rand -hex 32)

# Get Docker Hub credentials from the user
read -p "What is your docker hub username? " DOCKER_ID

while true
do
  read -s -p "What is your docker hub password? " DOCKER_PASSWD
  echo
  read -s -p "Enter your password again: " PASSWD_VERIFY

  if [[ "$DOCKER_PASSWD" != "$PASSWD_VERIFY" ]]; then
    echo "Passwords don't match, let's try that again..."
  else
    break
  fi
done


# Create secret.yaml
echo "Creating secret.yaml..."
cat secret.template.yaml | \
  sed -e "s/BINDERTOKEN/$BINDER_TOKEN/g" \
      -e "s/PROXYTOKEN/$PROXY_TOKEN/g" \
      -e "s/DOCKERID/$DOCKER_ID/g" \
      -e "s/DOCKERPASSWD/$DOCKER_PASSWD/g" \
  | cat - > secret.yaml


# Create config.yaml
echo "Creating config.yaml..."
cat config.template.yaml | \
  sed -e "s/DOCKERID/$DOCKER_ID/g" \
  | cat - > config.yaml


# Install BinderHub
echo "Installing BinderHub..."

# Add the Jupyterhub/BinderHub Helm repository 
helm repo add jupyterhub https://jupyterhub.github.io/helm-chart
helm repo update

# Install Binderhub
# (Replace -10ac4d8 after the version number with the hash
#  of the most recent version here:
#  https://jupyterhub.github.io/helm-chart/#development-releases-binderhub)
helm install jupyterhub/binderhub --version=0.2.0-10ac4d8 --name=binder --namespace=binder -f secret.yaml -f config.yaml

# Consult the README for what to do next...
